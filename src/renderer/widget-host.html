<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NxUI Widget</title>
  <style>
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent !important;
      user-select: none;
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #nxui-widget-root {
      width: 100%;
      height: 100%;
      position: relative;
      animation: nxui-entry 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    @keyframes nxui-entry {
      from {
        opacity: 0;
        transform: translateY(12px) scale(0.96);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .nxui-edit-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      border: 2px dashed rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      z-index: 9998;
      pointer-events: none;
      backdrop-filter: blur(2px);
      transition: all 0.2s ease;
      animation: nxui-edit-pulse 3s ease-in-out infinite;
    }

    .nxui-edit-overlay::after {
      content: "DRAG TO MOVE";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    body.nxui-edit-mode {
      pointer-events: all !important;
    }

    body.nxui-edit-mode .nxui-edit-overlay {
      display: block;
      pointer-events: all !important;
      cursor: grab !important;
    }

    body.nxui-edit-mode:active .nxui-edit-overlay {
      cursor: grabbing !important;
    }

    @keyframes nxui-edit-pulse {

      0%,
      100% {
        border-color: rgba(0, 212, 255, 0.6);
        box-shadow: 0 0 0 0 rgba(0, 212, 255, 0);
      }

      50% {
        border-color: rgba(0, 212, 255, 0.3);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.1);
      }
    }

    .nxui-error-overlay {
      position: absolute;
      inset: 0;
      background: rgba(220, 38, 38, 0.92);
      color: white;
      padding: 20px;
      font-size: 14px;
      overflow: auto;
      z-index: 9999;
      border-radius: 8px;
      border: 1px solid #f87171;
      backdrop-filter: blur(10px);
    }

    .nxui-error-overlay .error-title {
      font-weight: 700;
      margin-bottom: 8px;
      font-size: 13px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .nxui-error-overlay .error-message {
      font-family: 'Cascadia Code', 'Fira Code', monospace;
      white-space: pre-wrap;
      font-size: 12px;
      color: #fee2e2;
      line-height: 1.5;
    }
  </style>
</head>

<body>
  <div id="nxui-widget-root"></div>
  <div class="nxui-edit-overlay">
  </div>

  <script>
    (function () {
      let widgetId = "";
      let intervals = [];
      let timeouts = [];
      let isDragging = false;
      let dragStartX = 0;
      let dragStartY = 0;

      window.nxui.onInit((data) => {
        widgetId = data.id;

        if (data.styles) {
          const styleEl = document.createElement("style");
          styleEl.textContent = data.styles;
          document.head.appendChild(styleEl);
        }

        const root = document.getElementById("nxui-widget-root");
        root.innerHTML = data.html || "";

        if (data.clickThrough) {
          document.body.style.pointerEvents = "none";
        }

        setupDrag(root);

        if (data.onMountCode) {
          try {
            let onMount;
            const code = data.onMountCode.trim();

            if (code.startsWith("onMount") && code.indexOf("(") < code.indexOf("{")) {
              const obj = eval("({" + code + "})");
              onMount = obj.onMount;
            } else {
              onMount = eval("(" + code + ")");
            }

            const ctx = {
              getElementById: (id) => document.getElementById(id),
              querySelector: (sel) => root.querySelector(sel),
              querySelectorAll: (sel) => root.querySelectorAll(sel),
              getRoot: () => root,

              setInterval: (cb, ms) => {
                const id = window.setInterval(cb, ms);
                intervals.push(id);
                return id;
              },
              setTimeout: (cb, ms) => {
                const id = window.setTimeout(cb, ms);
                timeouts.push(id);
                return id;
              },
              clearInterval: (id) => {
                window.clearInterval(id);
                intervals = intervals.filter(i => i !== id);
              },
              clearTimeout: (id) => {
                window.clearTimeout(id);
                timeouts = timeouts.filter(i => i !== id);
              },

              sendToMain: (ch, d) => window.nxui.sendToMain(ch, d),
              onMessage: (ch, cb) => window.nxui.onMessage(ch, cb),

              getSystemStats: () => window.nxui.getSystemStats(),
              fetch: (url) => window.nxui.fetch(url),

              readFile: (path) => window.nxui.readFile(path),
              writeFile: (path, content) => window.nxui.writeFile(path, content),
              showOpenDialog: (options) => window.nxui.showOpenDialog(options),
            };

            onMount(ctx);
          } catch (err) {
            console.error("[NxUI] Widget error:", err);
            showErrorOverlay(root, err.message);
          }
        }
      });

      window.nxui.onEditModeChanged((enabled) => {
        document.body.classList.toggle("nxui-edit-mode", enabled);
      });

      function showErrorOverlay(root, message) {
        const overlay = document.createElement("div");
        overlay.className = "nxui-error-overlay";
        overlay.innerHTML = `
          <div class="error-title">Widget Error</div>
          <div class="error-message">${message}</div>
        `;
        root.appendChild(overlay);
      }

      function setupDrag(root) {
        document.body.addEventListener("mousedown", (e) => {
          if (!document.body.classList.contains("nxui-edit-mode")) return;

          if (e.button !== 0) return;
          const tag = e.target.tagName.toLowerCase();
          if (["input", "textarea", "button", "select", "a"].includes(tag)) return;

          isDragging = true;
          dragStartX = e.screenX;
          dragStartY = e.screenY;
          e.preventDefault();
        });

        document.addEventListener("mousemove", (e) => {
          if (!isDragging) return;
          const dx = e.screenX - dragStartX;
          const dy = e.screenY - dragStartY;
          if (dx !== 0 || dy !== 0) {
            window.nxui.dragMove(dx, dy, widgetId);
            dragStartX = e.screenX;
            dragStartY = e.screenY;
          }
        });

        document.addEventListener("mouseup", () => { isDragging = false; });
      }

      window.addEventListener("beforeunload", () => {
        intervals.forEach(id => window.clearInterval(id));
        timeouts.forEach(id => window.clearTimeout(id));
      });
    })();
  </script>
</body>

</html>